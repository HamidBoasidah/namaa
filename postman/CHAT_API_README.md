# دليل استخدام Chat System API - Postman Collection

## نظرة عامة
هذا الملف يحتوي على مجموعة كاملة من طلبات API لاختبار نظام الدردشة المرتبط بالحجوزات.

## المتطلبات الأساسية
1. تثبيت Postman
2. تشغيل السيرفر المحلي على `http://localhost:8000`
3. قاعدة بيانات تحتوي على:
   - مستخدمين (عميل ومستشار)
   - حجز واحد على الأقل بحالة "confirmed"

## خطوات الاستيراد
1. افتح Postman
2. اضغط على "Import"
3. اختر ملف `chat-api.collection.json`
4. سيتم استيراد المجموعة تلقائياً

## المتغيرات (Variables)
المجموعة تحتوي على المتغيرات التالية:

| المتغير | القيمة الافتراضية | الوصف |
|---------|-------------------|-------|
| `base_url` | `http://localhost:8000/api` | عنوان API الأساسي |
| `token` | (فارغ) | يتم ملؤه تلقائياً بعد تسجيل الدخول |
| `booking_id` | (فارغ) | معرف الحجز - يجب تعبئته يدوياً |
| `conversation_id` | (فارغ) | يتم ملؤه تلقائياً بعد إنشاء المحادثة |
| `message_id` | (فارغ) | يتم ملؤه تلقائياً بعد إرسال رسالة |
| `attachment_id` | (فارغ) | يجب تعبئته يدوياً من استجابة الرسالة |

## خطوات الاختبار

### 1. تسجيل الدخول

**كعميل:**
- افتح طلب "Auth > Login (Client)"
- عدّل البريد الإلكتروني وكلمة المرور حسب بياناتك
- اضغط "Send"
- سيتم حفظ التوكن تلقائياً في المتغير `token`

**كمستشار:**
- افتح طلب "Auth > Login (Consultant)"
- عدّل البريد الإلكتروني وكلمة المرور حسب بياناتك
- اضغط "Send"
- سيتم حفظ التوكن تلقائياً في المتغير `token`

### 2. تعيين معرف الحجز
- اذهب إلى "Variables" في المجموعة
- عيّن قيمة `booking_id` بمعرف حجز موجود في قاعدة البيانات
- تأكد أن الحجز بحالة "confirmed"

### 3. إنشاء أو الحصول على محادثة
- افتح طلب "Conversations > Get or Create Conversation"
- اضغط "Send"
- سيتم حفظ `conversation_id` تلقائياً

### 4. إرسال الرسائل

#### رسالة نصية فقط:
- افتح "Messages > Send Text Message"
- عدّل نص الرسالة في `body`
- اضغط "Send"

#### رسالة مع مرفقات:
- افتح "Messages > Send Message with Attachments"
- أضف ملفات في حقل `files[]`
- اضغط "Send"

#### مرفق فقط:
- افتح "Messages > Send Attachment Only"
- أضف ملف في حقل `files[]`
- اضغط "Send"

### 5. عرض الرسائل
- افتح "Messages > List Messages"
- اضغط "Send"
- ستحصل على قائمة الرسائل مع المرفقات

### 6. تحميل مرفق
- من استجابة الرسالة، انسخ `attachment_id`
- عيّن قيمة المتغير `attachment_id`
- افتح "Attachments > Download Attachment"
- اضغط "Send"

## سيناريوهات الاختبار

### اختبار حد الرسائل للعميل

1. سجل دخول كعميل
2. أرسل "Client - First Out-of-Session Message" ✅ (يجب أن ينجح)
3. أرسل "Client - Second Out-of-Session Message" ✅ (يجب أن ينجح)
4. أرسل "Client - Third Out-of-Session Message" ❌ (يجب أن يفشل - 403)

### اختبار رسائل المستشار غير المحدودة
1. سجل دخول كمستشار
2. أرسل "Consultant - Unlimited Out-of-Session Messages" عدة مرات
3. جميع الرسائل يجب أن تنجح ✅

### اختبار الصلاحيات
1. سجل دخول كمستخدم غير مشارك في المحادثة
2. حاول الوصول للمحادثة باستخدام "Non-Participant Access"
3. يجب أن تحصل على خطأ 403 ❌

### اختبار التحقق من الملفات
1. حاول إرسال ملف بصيغة غير مسموحة (مثل .exe)
2. استخدم "Invalid File Type"
3. يجب أن تحصل على خطأ 422 ❌

### اختبار الرسالة الفارغة
1. حاول إرسال رسالة بدون نص أو مرفقات
2. استخدم "Empty Message"
3. يجب أن تحصل على خطأ 422 ❌

## قواعد العمل المهمة

### حدود الرسائل
- **العميل خارج وقت الجلسة:** رسالتان فقط
- **العميل داخل وقت الجلسة:** غير محدود
- **المستشار:** غير محدود في جميع الأوقات

### حالات الحجز
- يمكن إرسال الرسائل فقط للحجوزات بحالة **"confirmed"**
- الحجوزات بحالة pending/cancelled/completed/expired لا تسمح بالرسائل

### المرفقات
- **الحد الأقصى للملفات:** 5 ملفات لكل رسالة
- **الحد الأقصى لحجم الملف:** 25 ميجابايت
- **الصيغ المسموحة:**
  - الصور: JPEG, PNG, WebP, GIF
  - المستندات: PDF, Word, Excel

### الصلاحيات
- فقط المشاركون في المحادثة (العميل والمستشار) يمكنهم:
  - عرض المحادثة
  - إرسال الرسائل
  - عرض الرسائل
  - تحميل المرفقات

## رموز الاستجابة

| الرمز | المعنى |
|------|--------|
| 200 | نجح الطلب |
| 201 | تم الإنشاء بنجاح |
| 401 | غير مصرح - تحتاج لتسجيل الدخول |
| 403 | ممنوع - ليس لديك صلاحية |
| 404 | غير موجود |
| 422 | خطأ في التحقق من البيانات |

## نصائح للاختبار


1. **استخدم Environment:** يمكنك إنشاء بيئات مختلفة (Development, Staging, Production)
2. **احفظ الاستجابات:** احفظ الاستجابات الناجحة كأمثلة للرجوع إليها
3. **اختبر السيناريوهات السلبية:** اختبر الحالات التي يجب أن تفشل للتأكد من الأمان
4. **راقب وقت الجلسة:** لاختبار الرسائل داخل/خارج وقت الجلسة، تأكد من وقت بدء الحجز
5. **استخدم Pre-request Scripts:** يمكنك إضافة سكريبتات لتوليد بيانات تلقائية

## استكشاف الأخطاء

### خطأ 401 (Unauthorized)
- تأكد من تسجيل الدخول أولاً
- تحقق من صلاحية التوكن
- تأكد من إضافة `Authorization: Bearer {{token}}` في الهيدر

### خطأ 403 (Forbidden)
- تأكد أنك مشارك في المحادثة
- تحقق من حالة الحجز (يجب أن تكون confirmed)
- تحقق من عدد الرسائل إذا كنت عميلاً

### خطأ 404 (Not Found)
- تأكد من صحة `booking_id` أو `conversation_id`
- تحقق من وجود السجل في قاعدة البيانات

### خطأ 422 (Validation Error)
- تحقق من صيغة الملفات المرفقة
- تأكد من حجم الملفات (أقل من 25MB)
- تأكد من وجود نص أو مرفقات في الرسالة

## أمثلة على الاستجابات

### محادثة ناجحة
```json
{
  "data": {
    "id": 1,
    "booking_id": 42,
    "participants": [
      {
        "id": 10,
        "name": "أحمد محمد",
        "avatar": "https://..."
      },
      {
        "id": 20,
        "name": "د. سارة أحمد",
        "avatar": "https://..."
      }
    ],
    "created_at": "2025-01-20T10:00:00Z"
  }
}
```

### رسالة مع مرفقات
```json
{
  "data": {
    "id": 102,
    "conversation_id": 1,
    "sender_id": 10,
    "sender_name": "أحمد محمد",
    "body": "إليك المستندات المطلوبة",
    "type": "mixed",
    "context": "out_of_session",
    "attachments": [
      {
        "id": 50,
        "original_name": "document.pdf",
        "mime_type": "application/pdf",
        "size_bytes": 1048576,
        "download_url": "/api/attachments/50"
      }
    ],
    "created_at": "2025-01-20T10:10:00Z"
  }
}
```

## الدعم
للمزيد من المعلومات، راجع:
- ملف التصميم: `.kiro/specs/booking-chat-system/design.md`
- ملف المتطلبات: `.kiro/specs/booking-chat-system/requirements.md`
- الاختبارات: `tests/Feature/Api/`
